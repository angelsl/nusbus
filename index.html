<!DOCTYPE html>
<html>
<head>
    <title>NUS Next Bus</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        // https://nextbus.comfortdelgro.com.sg/eventservice.svc/BusStops
        // Retrieved at 2018-10-10 00:27
        let stops = [{"caption":"AS5","latitude":1.2936110496521,"longitude":103.771942138672,"name":"AS7"},{"caption":"BIZ 2","latitude":1.29333997411937,"longitude":103.775159716606,"name":"BIZ2"},{"caption":"Botanic Gardens MRT","latitude":1.32270002365112,"longitude":103.815101623535,"name":"BG-MRT"},{"caption":"Central Library","latitude":1.29649996757507,"longitude":103.772399902344,"name":"CENLIB"},{"caption":"College Green","latitude":1.32333302497864,"longitude":103.816307067871,"name":"CGH"},{"caption":"COM2","latitude":1.29416704177856,"longitude":103.773612976074,"name":"COM2"},{"caption":"EA","latitude":1.30040001869202,"longitude":103.77010345459,"name":"BLK-EA-OPP"},{"caption":"Information Technology","latitude":1.29737591743469,"longitude":103.772850036621,"name":"COMCEN"},{"caption":"Kent Ridge Bus Terminal","latitude":1.29416704177856,"longitude":103.769721984863,"name":"KR-BT"},{"caption":"Kent Ridge MRT","latitude":1.29379999637604,"longitude":103.784896850586,"name":"KR-MRT"},{"caption":"Kent Vale","latitude":1.30192828316893,"longitude":103.769448161125,"name":"KV"},{"caption":"LT13","latitude":1.29429996013641,"longitude":103.770797729492,"name":"LT13"},{"caption":"LT27","latitude":1.29739999771118,"longitude":103.780899047852,"name":"LT27"},{"caption":"Museum","latitude":1.30110192298889,"longitude":103.77367401123,"name":"MUSEUM"},{"caption":"Oei Tiong Ham Building","latitude":1.31910002231598,"longitude":103.816802978516,"name":"BUKITTIMAH-BTC2"},{"caption":"Opp HSSML","latitude":1.29277801513672,"longitude":103.775001525879,"name":"HSSML-OPP"},{"caption":"Opp Kent Ridge MRT","latitude":1.2936999797821,"longitude":103.785202026367,"name":"KR-MRT-OPP"},{"caption":"Opp NUSS","latitude":1.29330003261566,"longitude":103.772399902344,"name":"NUSS-OPP"},{"caption":"Opp TCOMS","latitude":1.29379999637604,"longitude":103.777000427246,"name":"PGP12-OPP"},{"caption":"Opp UHall","latitude":1.29750001430511,"longitude":103.778297424316,"name":"UHALL-OPP"},{"caption":"Opp University Health Centre","latitude":1.29882680680667,"longitude":103.775636911392,"name":"STAFFCLUB-OPP"},{"caption":"Opp YIH","latitude":1.29910004138947,"longitude":103.774299621582,"name":"YIH-OPP"},{"caption":"PGP Hse 15","latitude":1.29305601119995,"longitude":103.777778625488,"name":"PGP14-15"},{"caption":"PGP Hse 7","latitude":1.29320001602173,"longitude":103.777801513672,"name":"PGP7"},{"caption":"PGPR","latitude":1.29083299636841,"longitude":103.780830383301,"name":"PGP"},{"caption":"Prince George's Park","latitude":1.29194402694702,"longitude":103.7802734375,"name":"PGPT"},{"caption":"Raffles Hall","latitude":1.30098046116879,"longitude":103.772702395916,"name":"RAFFLES"},{"caption":"S17","latitude":1.29747665891241,"longitude":103.781354546547,"name":"S17"},{"caption":"TCOMS","latitude":1.2936110496521,"longitude":103.776947021484,"name":"PGP12"},{"caption":"The Japanese Primary School","latitude":1.30073094367981,"longitude":103.769973754883,"name":"JP-SCH-16151"},{"caption":"UHall","latitude":1.29748737812042,"longitude":103.77791595459,"name":"UHALL"},{"caption":"University Health Centre","latitude":1.2989000082016,"longitude":103.776298522949,"name":"STAFFCLUB"},{"caption":"University Town","latitude":1.30357886193758,"longitude":103.774490177631,"name":"UTown"},{"caption":"Ventus (Opp LT13)","latitude":1.29530000686646,"longitude":103.770599365234,"name":"LT13-OPP"},{"caption":"YIH","latitude":1.29869997501373,"longitude":103.774299621582,"name":"YIH"}];

        function replace_results_with(new_div) {
            let old = document.getElementById("results");
            document.body.removeChild(old);
            document.body.appendChild(new_div);
        }

        function new_results_div() {
            let div = document.createElement("div");
            div.id = "results";
            return div;
        }

        function populate_results(shuttles) {
            let lis = shuttles.map(function(shuttle) {
                let str = shuttle.name + ": " + shuttle.arrivalTime + " min ("
                    + shuttle.passengers + "), " + shuttle.nextArrivalTime + " min ("
                    + shuttle.nextPassengers + ")";
                let li = document.createElement("li");
                li.innerText = str;
                return li;
            });
            let ul = document.createElement("ul");
            for (let li of lis) {
                ul.appendChild(li);
            }
            let div = new_results_div();
            div.appendChild(ul);
            replace_results_with(div);
        }

        function load_results(stop) {
            let xhr = new XMLHttpRequest();
            xhr.addEventListener("load", function() {
                populate_results(JSON.parse(this.responseText).ShuttleServiceResult.shuttles);
            });
            xhr.addEventListener("error", function() {
                let div = new_results_div();
                div.innerText = "Error while loading results: " + this.status + " " + this.statusText;
                replace_results_with(div);
            });
            xhr.open("GET", "https://cors.io/?https://nextbus.comfortdelgro.com.sg/eventservice.svc/Shuttleservice?busstopname=" + stop);
            xhr.send();
        }

        function select_onchange() {
            document.getElementById("results").style = "display: none;";
            let stop = document.getElementById("stop").value;
            if (stop != "") {
                load_results(stop);
            }
        }

        function populate_select() {
            let options = [(function() {
                let option = document.createElement("option");
                option.value = "";
                option.innerText = "Select a stop";
                return option;
            })()].concat(stops.map(function(stop) {
                let option = document.createElement("option");
                option.value = stop.name;
                option.innerText = stop.caption + " (" + stop.name + ")";
                return option;
            }));

            let old_select = document.getElementById("stop");
            let new_select = old_select.cloneNode(false);
            for (let option of options) {
                new_select.appendChild(option);
            }
            new_select.disabled = false;
            new_select.value = old_select.value;
            new_select.onchange = select_onchange;
            old_select.parentNode.replaceChild(new_select, old_select);
        }

        function refresh_stops() {
            let xhr = new XMLHttpRequest();
            xhr.addEventListener("load", function() {
                let new_stops = JSON.parse(this.responseText).BusStopsResult.busstops;
                if (JSON.stringify(stops) != JSON.stringify(new_stops)) { // FIXME
                    stops = new_stops;
                    populate_select();
                }

            });
            xhr.addEventListener("error", populate_select);
            xhr.open("GET", "https://cors.io/?https://nextbus.comfortdelgro.com.sg/eventservice.svc/BusStops");
            xhr.send();
        }

        window.onload = function() {
            populate_select();
            refresh_stops();
        };
    </script>
    <style>
        #stop, #refresh {
            width: 100%;
        }

        body {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div>
        <select id="stop" disabled="disabled">
            <option value="">Select a stop</option>
        </select>
    </div>
    <div>
        <button id="refresh" onclick="select_onchange();">Refresh</button>
    </div>
    <div id="results">
    </div>
</body>
</html>
